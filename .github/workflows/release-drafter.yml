name: Release Drafter

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-drafter
  cancel-in-progress: false

jobs:
  update-release-draft:
    if: github.repository == 'wallstop/DxMessaging'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from package.json
        id: version
        run: |
          if [ ! -f package.json ]; then
            echo "Error: package.json not found"
            exit 1
          fi
          VERSION=$(jq -r '.version // empty' package.json)
          if [ -z "$VERSION" ]; then
            echo "Error: version field not found in package.json"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Extracted version: $VERSION"

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Looking for version: $VERSION"

          if [ ! -f CHANGELOG.md ]; then
            echo "Warning: CHANGELOG.md not found"
            echo "No changelog file found." > /tmp/changelog_section.md
            echo "changelog_file=/tmp/changelog_section.md" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Extract the changelog section for this version
          # Matches from "## [VERSION]" until the next "## [" or end of file
          CHANGELOG_CONTENT=$(awk -v ver="$VERSION" '
            BEGIN { found=0; content="" }
            /^## \[/ {
              if (found) exit
              if (index($0, "[" ver "]") > 0) {
                found=1
                next
              }
            }
            found { content = content $0 "\n" }
            END { print content }
          ' CHANGELOG.md)

          # Handle empty changelog
          if [ -z "$CHANGELOG_CONTENT" ] || [ "$CHANGELOG_CONTENT" = $'\n' ]; then
            CHANGELOG_CONTENT="No changelog entry found for version $VERSION"
          fi

          # Write to file for multi-line handling
          echo "$CHANGELOG_CONTENT" > /tmp/changelog_section.md
          echo "changelog_file=/tmp/changelog_section.md" >> "$GITHUB_OUTPUT"

      - name: Run Release Drafter
        uses: release-drafter/release-drafter@v6
        id: release_drafter
        with:
          config-name: release-drafter.yml
          version: ${{ steps.version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update release body with changelog
        uses: actions/github-script@v7
        env:
          RELEASE_ID: ${{ steps.release_drafter.outputs.id }}
          VERSION: ${{ steps.version.outputs.version }}
          DRAFTER_BODY: ${{ steps.release_drafter.outputs.body }}
          CHANGELOG_FILE: ${{ steps.changelog.outputs.changelog_file }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const releaseId = parseInt(process.env.RELEASE_ID, 10);
            if (!Number.isInteger(releaseId) || releaseId <= 0) {
              throw new Error('Invalid releaseId: ' + process.env.RELEASE_ID + '. Expected a positive integer.');
            }
            const version = process.env.VERSION;
            const drafterBody = process.env.DRAFTER_BODY || '';
            const changelogFile = process.env.CHANGELOG_FILE;

            let changelogContent = '';
            try {
              changelogContent = fs.readFileSync(changelogFile, 'utf8').trim();
            } catch (err) {
              console.log('Warning: Could not read changelog file:', err.message);
              changelogContent = 'No changelog content available.';
            }

            const bodyParts = [
              '## Changelog',
              '',
              changelogContent,
              '',
              '---',
              '',
              drafterBody
            ];
            const body = bodyParts.join('\n');

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              body: body,
              name: version,
              tag_name: version
            });

            console.log('Updated release draft for version ' + version);
