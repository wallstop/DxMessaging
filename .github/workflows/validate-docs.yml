# Validate Documentation
#
# This workflow validates MkDocs documentation on PRs and pushes to catch
# issues before merge. It performs strict builds, link validation, and
# verifies required documentation files exist.
#
# Unlike deploy-docs.yml which also deploys, this workflow focuses purely
# on validation and can run with minimal permissions.

name: Validate Documentation

on:
  pull_request:
    paths:
      - "docs/**"
      - "mkdocs.yml"
      - "requirements-docs.txt"
      - ".github/workflows/validate-docs.yml"
  push:
    branches:
      - master
    paths:
      - "docs/**"
      - "mkdocs.yml"
      - "requirements-docs.txt"
      - ".github/workflows/validate-docs.yml"
  workflow_dispatch:

# Cancel in-progress runs for the same branch to save resources
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate:
    name: Validate Documentation Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history for git-revision-date-localized plugin
          persist-credentials: false

      - name: Verify required documentation files exist
        run: |
          echo "Checking for required documentation files..."
          MISSING_FILES=0

          # Check core configuration files
          for file in mkdocs.yml requirements-docs.txt; do
            if [ ! -f "$file" ]; then
              echo "::error file=$file::Required file '$file' not found"
              MISSING_FILES=$((MISSING_FILES + 1))
            else
              echo "âœ… Found: $file"
            fi
          done

          # Check required documentation structure
          for file in docs/index.md; do
            if [ ! -f "$file" ]; then
              echo "::error file=$file::Required documentation file '$file' not found"
              MISSING_FILES=$((MISSING_FILES + 1))
            else
              echo "âœ… Found: $file"
            fi
          done

          # Check for key documentation directories
          for dir in docs/getting-started docs/concepts docs/reference; do
            if [ ! -d "$dir" ]; then
              echo "::warning::Documentation directory '$dir' not found - consider adding it"
            else
              FILE_COUNT=$(find "$dir" -name '*.md' | wc -l)
              echo "âœ… Found: $dir ($FILE_COUNT markdown files)"
            fi
          done

          if [ "$MISSING_FILES" -gt 0 ]; then
            echo "::error::$MISSING_FILES required file(s) missing"
            exit 1
          fi

          echo ""
          echo "ğŸ“‹ All required documentation files present"

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "requirements-docs.txt"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libcairo2-dev \
            libfreetype6-dev \
            libffi-dev \
            libjpeg-dev \
            libpng-dev \
            libz-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-docs.txt

      - name: Validate mkdocs.yml syntax
        run: |
          echo "Validating mkdocs.yml syntax..."
          python -c "from mkdocs.config import load_config; load_config('mkdocs.yml')"
          echo "âœ… mkdocs.yml syntax validation passed"

      - name: Build documentation (strict mode)
        run: |
          echo "Building documentation in strict mode..."
          mkdocs build --strict --site-dir _site 2>&1 | tee build.log

          # Check for warnings in the build log
          if grep -qi "warning" build.log; then
            echo ""
            echo "::warning::Build completed with warnings - review output above"
          fi

          echo ""
          echo "âœ… Documentation build completed successfully"

      - name: Validate build output
        run: |
          echo "Validating build output..."

          if [ ! -d "_site" ]; then
            echo "::error::Build failed - _site directory not found"
            exit 1
          fi

          if [ ! -f "_site/index.html" ]; then
            echo "::error::Build failed - index.html not found"
            exit 1
          fi

          # Count generated pages
          PAGE_COUNT=$(find _site -name '*.html' | wc -l)
          echo "ğŸ“„ Generated $PAGE_COUNT HTML pages"

          if [ "$PAGE_COUNT" -lt 5 ]; then
            echo "::warning::Low page count ($PAGE_COUNT) - verify all docs are being built"
          fi

          # Show site structure summary
          echo ""
          echo "ğŸ“ Site structure:"
          find _site -type d | head -20

          echo ""
          echo "âœ… Build output validation passed"

      - name: Check internal link structure
        run: |
          echo "Checking internal link structure..."

          # Count internal links in generated HTML
          # Use || true to prevent exit code 1 from grep when no matches
          LINK_COUNT=$(grep -roc 'href="[^"]*"' _site --include='*.html' | awk -F: '{sum+=$NF} END {print sum}' || echo "0")
          # For internal links, pipe through awk to count instead of grep -c which exits 1 on no match
          # shellcheck disable=SC2126  # wc -l intentional: grep -c exits 1 on no match, breaking CI
          INTERNAL_LINKS=$(grep -roh 'href="[^"]*"' _site --include='*.html' 2>/dev/null | grep -v 'href="https\?://\|href="mailto:' | wc -l || echo "0")

          echo "ğŸ“Š Found $LINK_COUNT total links ($INTERNAL_LINKS internal)"
          echo "âœ… Link structure scan completed"
          echo ""
          echo "Note: For comprehensive link validation, consider running:"
          echo "  pip install linkchecker && linkchecker _site/index.html"

      - name: Summary
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                 DOCUMENTATION VALIDATION COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Required files present"
          echo "âœ… mkdocs.yml syntax valid"
          echo "âœ… Documentation built successfully in strict mode"
          echo "âœ… Build output validated"
          echo "âœ… Internal links checked"
          echo ""
          echo "The documentation is ready for deployment!"
