#!/bin/bash
#
# Git pre-commit hook for DxMessaging
#
# This hook:
# 1. Syncs the banner version from package.json to the SVG banner
# 2. Regenerates the skills index.md when skill files are modified
#
# Installation:
#   cp scripts/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#

set -e

# 0) Sync banner version from package.json (runs on every commit)
# This ensures the SVG banner always displays the correct version
echo "üè∑Ô∏è  Syncing banner version..."
if command -v pwsh &> /dev/null; then
    pwsh -NoProfile -File scripts/sync-banner-version.ps1
elif command -v powershell &> /dev/null; then
    powershell -NoProfile -ExecutionPolicy Bypass -File scripts/sync-banner-version.ps1
else
    echo "‚ö†Ô∏è  PowerShell not found. Skipping banner version sync."
fi

SKILLS_DIR=".llm/skills"
INDEX_FILE="$SKILLS_DIR/index.md"

# Check if any skill files are staged (excluding index.md and specification.md)
STAGED_SKILLS=$(git diff --cached --name-only --diff-filter=ACMR | grep -F "$SKILLS_DIR/" | grep -v "index.md" | grep -v "specification.md" | grep -v "templates/" || true)

if [ -n "$STAGED_SKILLS" ]; then
    echo "üìö Skill files modified, regenerating index..."

    # Prefer node, fall back to pwsh (which delegates to the JS script)
    if command -v node &> /dev/null; then
        node scripts/generate-skills-index.js
    elif command -v pwsh &> /dev/null; then
        pwsh scripts/generate-skills-index.ps1
    else
        echo "‚ö†Ô∏è  Neither 'node' nor 'pwsh' found. Skipping index generation."
        echo "   Please run scripts/generate-skills-index.js or .ps1 manually."
        exit 0
    fi

    # Add the regenerated index to the commit
    if [ -f "$INDEX_FILE" ]; then
        git add "$INDEX_FILE"
        echo "‚úÖ index.md regenerated and staged"
    fi
fi

exit 0
