<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>netstandard2.0</TargetFramework>
    <LangVersion>latest</LangVersion>
  </PropertyGroup>
  <ItemGroup>
    <PackageReference Include="Microsoft.CodeAnalysis.Analyzers" Version="3.3.3">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Microsoft.CodeAnalysis.CSharp" Version="4.2.0">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="System.Collections.Immutable" Version="5.0.0">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
  </ItemGroup>
  <!-- Post-build copy of analyzer DLL/PDB into package Editor/Analyzers and, when building inside a Unity project Packages/, into Assets/Editor/Wallstop Studios -->
  <Target Name="PostBuildCopyAnalyzers" AfterTargets="Build">
    <!-- Compute paths relative to this project directory -->
    <PropertyGroup>
      <!-- Repo/package root: two levels up from this project directory -->
      <PackageRootDir>$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)/../../'))</PackageRootDir>
      <EditorAnalyzersDir>$([System.IO.Path]::Combine('$(PackageRootDir)', 'Editor', 'Analyzers'))</EditorAnalyzersDir>
      <!-- Unity project root candidate when this package is inside Unity's Packages folder (4 levels up) -->
      <UnityRootCandidate1>$([System.IO.Path]::GetFullPath('$(MSBuildProjectDirectory)/../../../../'))</UnityRootCandidate1>
      <UnityAssetsDir>$([System.IO.Path]::Combine('$(UnityRootCandidate1)', 'Assets'))</UnityAssetsDir>
      <UnityAssetsEditorDir>$([System.IO.Path]::Combine('$(UnityAssetsDir)', 'Editor'))</UnityAssetsEditorDir>
      <UnityAssetsEditorWallstopStudiosDir>$([System.IO.Path]::Combine('$(UnityAssetsEditorDir)', 'Wallstop Studios'))</UnityAssetsEditorWallstopStudiosDir>
      <UnityAssetsPluginsEditorWallstopDir>$([System.IO.Path]::Combine('$(UnityAssetsDir)', 'Plugins', 'Editor', 'WallstopStudios.DxMessaging'))</UnityAssetsPluginsEditorWallstopDir>
      <AnalyzerDll>$(TargetPath)</AnalyzerDll>
      <AnalyzerPdb>$(TargetDir)$(TargetName).pdb</AnalyzerPdb>
    </PropertyGroup>
    <ItemGroup>
      <AnalyzerOutput Include="$(AnalyzerDll)" />
      <AnalyzerOutput Include="$(AnalyzerPdb)" Condition="Exists('$(AnalyzerPdb)')" />
    </ItemGroup>
    <!-- Copy into package Editor/Analyzers (used by SetupCscRsp and package consumers) -->
    <MakeDir Directories="$(EditorAnalyzersDir)" Condition="!Exists('$(EditorAnalyzersDir)')" />
    <Copy
      SourceFiles="@(AnalyzerOutput)"
      DestinationFolder="$(EditorAnalyzersDir)"
      SkipUnchangedFiles="true"
    />
    <!-- If building from inside a Unity project (Assets exists), also copy into Assets/Editor/Wallstop Studios -->
    <!-- Preferred legacy Plugins path used by SetupCscRsp -->
    <MakeDir
      Directories="$(UnityAssetsPluginsEditorWallstopDir)"
      Condition="Exists('$(UnityAssetsDir)') AND !Exists('$(UnityAssetsPluginsEditorWallstopDir)')"
    />
    <Copy
      SourceFiles="@(AnalyzerOutput)"
      DestinationFolder="$(UnityAssetsPluginsEditorWallstopDir)"
      SkipUnchangedFiles="true"
      Condition="Exists('$(UnityAssetsPluginsEditorWallstopDir)')"
    />
    <!-- Removed copy to Assets/Editor/Wallstop Studios as requested -->
  </Target>
</Project>
